using System;
using System.Drawing;
using System.Windows.Forms;
using Central_de_Software.Utilities;
using System.IO;
using System.Threading.Tasks;

public class UserControlSoftwareFunction : UserControl
{
    private string nomeSoftware;
    private string iconeSoftware;
    private TableLayoutPanel layout;

    public UserControlSoftwareFunction(string nome, string icone)
    {
        nomeSoftware = nome;
        iconeSoftware = icone;
        InitializeComponent();
    }

    private void InitializeComponent()
    {
        this.Dock = DockStyle.Fill;
        this.BackColor = Color.White;
        var corAzul = ColorTranslator.FromHtml("#1A377B");
        var corLaranja = ColorTranslator.FromHtml("#F15A22");

        layout = new TableLayoutPanel
        {
            Dock = DockStyle.Top,
            ColumnCount = 2,
            RowCount = 1,
            AutoSize = true,
            BackColor = Color.White,
            Padding = new Padding(40, 30, 40, 0),
            CellBorderStyle = TableLayoutPanelCellBorderStyle.None
        };
        layout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50F));
        layout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50F));
        layout.RowStyles.Add(new RowStyle(SizeType.AutoSize));

        if (!string.IsNullOrEmpty(nomeSoftware))
        {
            var btnInstalar = new Button
            {
                Text = $"Instalar {nomeSoftware}",
                Width = 260,
                Height = 48,
                Font = new Font("Segoe UI", 13, FontStyle.Bold),
                BackColor = Color.White,
                ForeColor = corAzul,
                FlatStyle = FlatStyle.Flat,
                Margin = new Padding(10, 10, 10, 10),
                Anchor = AnchorStyles.Left | AnchorStyles.Top
            };
            btnInstalar.FlatAppearance.BorderSize = 0;
            btnInstalar.FlatAppearance.MouseOverBackColor = Color.FromArgb(230, 230, 255);
            btnInstalar.Click += async (s, e) => await InstalarSoftware();

            var btnDesinstalar = new Button
            {
                Text = $"Desinstalar {nomeSoftware}",
                Width = 260,
                Height = 48,
                Font = new Font("Segoe UI", 13, FontStyle.Bold),
                BackColor = Color.White,
                ForeColor = corLaranja,
                FlatStyle = FlatStyle.Flat,
                Margin = new Padding(10, 10, 10, 10),
                Anchor = AnchorStyles.Left | AnchorStyles.Top
            };
            btnDesinstalar.FlatAppearance.BorderSize = 0;
            btnDesinstalar.FlatAppearance.MouseOverBackColor = Color.FromArgb(255, 230, 230);
            btnDesinstalar.Click += async (s, e) => await DesinstalarSoftware();

            layout.Controls.Add(btnInstalar, 0, 0);
            layout.Controls.Add(btnDesinstalar, 1, 0);

            if (nomeSoftware == "AnyDesk")
            {
                var btnLimparCache = new Button
                {
                    Text = "Limpar Cache do AnyDesk",
                    Width = 540,
                    Height = 48,
                    Font = new Font("Segoe UI", 13, FontStyle.Bold),
                    BackColor = Color.White,
                    ForeColor = corAzul,
                    FlatStyle = FlatStyle.Flat,
                    Margin = new Padding(10, 10, 10, 10),
                    Anchor = AnchorStyles.Left | AnchorStyles.Top
                };
                btnLimparCache.FlatAppearance.BorderSize = 0;
                btnLimparCache.FlatAppearance.MouseOverBackColor = Color.FromArgb(230, 230, 255);
                btnLimparCache.Click += async (s, e) => await LimparCacheAnyDesk();
                layout.RowCount = 2;
                layout.RowStyles.Add(new RowStyle(SizeType.AutoSize));
                layout.Controls.Add(btnLimparCache, 0, 1);
                layout.SetColumnSpan(btnLimparCache, 2);
            }
        }
        else
        {
            var label = new Label
            {
                Text = "Selecione um software no menu à esquerda para ver detalhes e instalar.",
                Font = new Font("Segoe UI", 16, FontStyle.Bold),
                ForeColor = corAzul,
                AutoSize = true,
                Margin = new Padding(10, 30, 10, 10),
                Anchor = AnchorStyles.Left | AnchorStyles.Top
            };
            layout.Controls.Add(label, 0, 0);
            layout.SetColumnSpan(label, 2);
        }
        this.Controls.Add(layout);
    }

    private async Task InstalarSoftware()
    {
        string resourceName = null, tempName = null, args = "";
        switch (nomeSoftware)
        {
            case "AnyDesk":
                resourceName = "Central_de_Software.softwares.AnyDesk.exe";
                tempName = "AnyDesk.exe";
                break;
            case "Google Chrome":
                resourceName = "Central_de_Software.softwares.ChromeSetup.exe";
                tempName = "ChromeSetup.exe";
                break;
            case "WinRAR":
                resourceName = "Central_de_Software.softwares.winrar-x64-713.exe";
                tempName = "winrar-x64-713.exe";
                break;
            case "WhatsApp Desktop":
                resourceName = "Central_de_Software.softwares.WhatsApp Installer.exe";
                tempName = "WhatsApp Installer.exe";
                break;
            case "Adobe Acrobat Reader":
                resourceName = "Central_de_Software.softwares.Reader_br_install.exe";
                tempName = "Reader_br_install.exe";
                break;
            case "Revo Uninstaller":
                resourceName = "Central_de_Software.softwares.revosetup.exe";
                tempName = "revosetup.exe";
                break;
            case "Office 365":
                resourceName = "Central_de_Software.softwares.Office365Setup.exe";
                tempName = "Office365Setup.exe";
                break;
        }
        if (resourceName != null && tempName != null)
        {
            try
            {
                await SoftwareInstaller.InstallFromEmbeddedAsync(resourceName, tempName, args, true);
                MessageBox.Show($"{nomeSoftware} instalado com sucesso!", "Instalação", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erro ao instalar {nomeSoftware}: {ex.Message}", "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
    }

    private async Task DesinstalarSoftware()
    {
        try
        {
            if (!SoftwareInstaller.IsSoftwareInstalled(nomeSoftware))
            {
                MessageBox.Show($"{nomeSoftware} não está instalado.", "Informação", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            var result = MessageBox.Show($"Tem certeza que deseja desinstalar {nomeSoftware}?", "Confirmação", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
            if (result == DialogResult.Yes)
            {
                var psi = new System.Diagnostics.ProcessStartInfo("cmd.exe", $"/c wmic product where \"Name like '%{nomeSoftware}%'\" call uninstall /nointeractive")
                {
                    UseShellExecute = true,
                    Verb = "runas",
                    CreateNoWindow = true
                };
                var proc = System.Diagnostics.Process.Start(psi);
                if (proc != null)
                {
                    await Task.Run(() => proc.WaitForExit());
                    MessageBox.Show($"Desinstalação de {nomeSoftware} concluída.", "Desinstalação", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Erro ao desinstalar {nomeSoftware}: {ex.Message}", "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

    private async Task LimparCacheAnyDesk()
    {
        try
        {
            var result = MessageBox.Show(
                "Isso irá desinstalar o AnyDesk, limpar o cache e reinstalá-lo novamente.\n\nDeseja continuar?",
                "Limpar Cache do AnyDesk",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Question);
            if (result == DialogResult.Yes)
            {
                await DesinstalarSoftware();
                string roaming = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
                string anydeskPath = Path.Combine(roaming, "AnyDesk");
                if (Directory.Exists(anydeskPath))
                {
                    Directory.Delete(anydeskPath, true);
                    MessageBox.Show("Cache do AnyDesk removido com sucesso!", "Limpeza de Cache", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                await InstalarSoftware();
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Erro ao limpar cache do AnyDesk: {ex.Message}", "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }
}
