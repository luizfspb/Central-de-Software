using System;
using System.Drawing;
using System.Windows.Forms;
using Central_de_Software.Utilities;

public class FormMain : Form
{
    private Panel panelMenuSuperior;
    private Button btnMenuInicio;
    private Button btnMenuSoftwares;
    private Button btnMenuTools;
    private Button btnMenuFiscal;
    private Panel panelLateral;
    private Panel panelCentral;

    // UserControls para cada tema
    private UserControlTools userControlTools = new UserControlTools();
    private UserControlFiscal userControlFiscal = new UserControlFiscal();
    private UserControlFiscalXmlEditor userControlFiscalXmlEditor = new UserControlFiscalXmlEditor();
    private UserControlHome userControlHome = new UserControlHome();
    private UserControlSoftware userControlSoftware = new UserControlSoftware();

    // Cores do tema
    private Color corAzul = ColorTranslator.FromHtml("#1A377B");
    private Color corLaranja = ColorTranslator.FromHtml("#F15A22");
    private Color corBranco = Color.White;
    private Color corCinza = Color.WhiteSmoke;

    // Lista de softwares
    private (string Nome, string Icone)[] softwares = new[]
    {
        ("AnyDesk", "anydesk.png"),
        ("Google Chrome", "chrome.png"),
        ("WinRAR", "winrar.png"),
        ("WhatsApp Desktop", "whatsapp.png"),
        ("Adobe Acrobat Reader", "adobe.png"),
        ("Revo Uninstaller", "revo.png"),
        ("Office 365", "office.png")
    };

    private bool modoTecnicoAtivo = false;
    private Button btnVoltarModoNormal;

    public static FormMain Instance { get; private set; }
    public bool IsModoTecnicoAtivo => modoTecnicoAtivo;

    public FormMain()
    {
        Instance = this;
        InitializeComponent();
        this.KeyPreview = true;
        this.KeyDown += FormMain_KeyDown;
    }

    private void FormMain_KeyDown(object sender, KeyEventArgs e)
    {
        if (e.Control && e.KeyCode == Keys.T)
        {
            AtivarModoTecnico();
        }
    }

    private void AtivarModoTecnico()
    {
        using (var prompt = new Form())
        {
            prompt.Width = 350;
            prompt.Height = 180;
            prompt.Text = "Modo Técnico - Autenticação";
            var lbl = new Label { Text = "Digite a senha do modo técnico:", Left = 20, Top = 20, Width = 300 };
            var txt = new TextBox { Left = 20, Top = 50, Width = 280, PasswordChar = '*' };
            var btnOk = new Button { Text = "OK", Left = 220, Width = 80, Top = 90, DialogResult = DialogResult.OK };
            var btnAlterar = new Button { Text = "Alterar Senha", Left = 20, Width = 120, Top = 90 };
            prompt.Controls.Add(lbl);
            prompt.Controls.Add(txt);
            prompt.Controls.Add(btnOk);
            prompt.Controls.Add(btnAlterar);
            prompt.AcceptButton = btnOk;
            prompt.StartPosition = FormStartPosition.CenterParent;
            string senhaAtual = TechModeConfig.GetPassword();
            btnAlterar.Click += (s, e) => {
                if (txt.Text == senhaAtual)
                {
                    using (var f = new Form())
                    {
                        f.Width = 350;
                        f.Height = 180;
                        f.Text = "Alterar Senha do Modo Técnico";
                        var lblNova = new Label { Text = "Nova senha:", Left = 20, Top = 20, Width = 300 };
                        var txtNova = new TextBox { Left = 20, Top = 50, Width = 280, PasswordChar = '*' };
                        var btnSalvar = new Button { Text = "Salvar", Left = 220, Width = 80, Top = 90, DialogResult = DialogResult.OK };
                        f.Controls.Add(lblNova);
                        f.Controls.Add(txtNova);
                        f.Controls.Add(btnSalvar);
                        f.AcceptButton = btnSalvar;
                        f.StartPosition = FormStartPosition.CenterParent;
                        if (f.ShowDialog() == DialogResult.OK)
                        {
                            if (!string.IsNullOrWhiteSpace(txtNova.Text))
                            {
                                TechModeConfig.SetPassword(txtNova.Text);
                                MessageBox.Show("Senha alterada com sucesso!", "Modo Técnico", MessageBoxButtons.OK, MessageBoxIcon.Information);
                            }
                        }
                    }
                }
                else
                {
                    MessageBox.Show("Senha atual incorreta!", "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            };
            if (prompt.ShowDialog() == DialogResult.OK)
            {
                if (txt.Text == senhaAtual)
                {
                    modoTecnicoAtivo = true;
                    AplicarTemaEscuro(true);
                    MessageBox.Show("Modo Técnico ativado! Funções avançadas liberadas.", "Modo Técnico", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                else
                {
                    MessageBox.Show("Senha incorreta!", "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }
    }

    private void VoltarModoNormal()
    {
        modoTecnicoAtivo = false;
        AplicarTemaEscuro(false);
        MessageBox.Show("Modo Técnico desativado.", "Modo Técnico", MessageBoxButtons.OK, MessageBoxIcon.Information);
    }

    private void AplicarTemaEscuro(bool escuro)
    {
        Color back = escuro ? Color.FromArgb(32, 32, 32) : corBranco;
        Color fore = escuro ? Color.White : corAzul;
        Color foreLaranja = escuro ? Color.Orange : corLaranja;
        this.BackColor = back;
        panelMenuSuperior.BackColor = escuro ? Color.FromArgb(24, 24, 24) : corCinza;
        panelLateral.BackColor = escuro ? Color.FromArgb(40, 40, 40) : Color.FromArgb(240, 240, 240);
        panelCentral.BackColor = back;
        foreach (Control c in panelMenuSuperior.Controls)
        {
            if (c is Button b)
            {
                b.BackColor = back;
                b.ForeColor = fore;
            }
        }
        foreach (Control c in panelLateral.Controls)
        {
            if (c is Button b)
            {
                b.BackColor = back;
                b.ForeColor = fore;
            }
        }
        foreach (Control c in panelCentral.Controls)
        {
            if (c is UserControl uc)
            {
                uc.BackColor = back;
                foreach (Control cc in uc.Controls)
                {
                    if (cc is Button b)
                    {
                        b.BackColor = back;
                        b.ForeColor = fore;
                    }
                    else if (cc is RichTextBox rtb)
                    {
                        rtb.BackColor = escuro ? Color.FromArgb(40, 40, 40) : Color.White;
                        rtb.ForeColor = fore;
                    }
                }
            }
        }
        // Botão de voltar
        if (escuro)
        {
            btnVoltarModoNormal.Visible = true;
        }
        else
        {
            btnVoltarModoNormal.Visible = false;
        }
        // Atualizar UserControls se necessário
        if (panelCentral.Controls.Count > 0 && panelCentral.Controls[0] is UserControl ucAtual && ucAtual is IModoTecnicoAware aware)
        {
            aware.OnModoTecnicoChanged(escuro);
        }
    }

    private void InitializeComponent()
    {
        this.Text = "Central de Software";
        this.Width = 950;
        this.Height = 700;
        this.FormBorderStyle = FormBorderStyle.FixedDialog;
        this.MaximizeBox = false;
        this.MinimizeBox = true;
        this.StartPosition = FormStartPosition.CenterScreen;
        this.MaximumSize = new Size(950, 700);
        this.MinimumSize = new Size(950, 700);

        // Menu superior
        panelMenuSuperior = new Panel { Height = 80, Dock = DockStyle.Top, BackColor = corCinza };
        btnMenuInicio = CriarBotaoMenu("  Início", ResourceImages.GetImage("home.png"), 20, 10, OnMenuClick, "inicio");
        btnMenuSoftwares = CriarBotaoMenu("  Softwares", ResourceImages.GetImage("software.png"), 220, 10, OnMenuClick, "softwares");
        btnMenuTools = CriarBotaoMenu("  Tools", ResourceImages.GetImage("tools.png"), 420, 10, OnMenuClick, "tools");
        btnMenuFiscal = CriarBotaoMenu("  Fiscal", ResourceImages.GetImage("fiscal.png"), 620, 10, OnMenuClick, "fiscal");
        
        // Botão Voltar para área normal
        btnVoltarModoNormal = new Button
        {
            Text = "Voltar para área normal",
            Width = 180,
            Height = 40,
            Top = 20,
            Left = 820,
            Anchor = AnchorStyles.Top | AnchorStyles.Right,
            BackColor = Color.FromArgb(64, 64, 64),
            ForeColor = Color.White,
            Font = new Font("Segoe UI", 10, FontStyle.Bold),
            FlatStyle = FlatStyle.Flat,
            Visible = false
        };
        btnVoltarModoNormal.FlatAppearance.BorderSize = 0;
        btnVoltarModoNormal.Click += (s, e) => VoltarModoNormal();
        
        panelMenuSuperior.Controls.AddRange(new Control[] { 
            btnMenuInicio, 
            btnMenuSoftwares, 
            btnMenuTools, 
            btnMenuFiscal,
            btnVoltarModoNormal 
        });

        // Painel lateral e central
        panelLateral = new Panel { Width = 220, Dock = DockStyle.Left, BackColor = Color.FromArgb(240, 240, 240) };
        panelCentral = new Panel { Dock = DockStyle.Fill, BackColor = Color.White };

        this.Controls.Add(panelCentral);
        this.Controls.Add(panelLateral);
        this.Controls.Add(panelMenuSuperior);

        // Exibe mensagem de boas-vindas ao abrir
        ShowLateralMenu("inicio");
        btnMenuInicio.BackColor = corAzul;
        btnMenuInicio.ForeColor = corBranco;
    }

    private Button CriarBotaoMenu(string texto, Image icone, int left, int top, EventHandler click, string tag)
    {
        var btn = new Button
        {
            Text = texto,
            TextAlign = ContentAlignment.MiddleRight,
            ImageAlign = ContentAlignment.MiddleLeft,
            Width = 180,
            Height = 60,
            FlatStyle = FlatStyle.Flat,
            Font = new Font("Segoe UI", 11, FontStyle.Bold),
            Image = icone,
            Location = new Point(left, top),
            Anchor = AnchorStyles.Top | AnchorStyles.Left,
            BackColor = corBranco,
            ForeColor = corAzul,
            Tag = tag,
            TabStop = false
        };
        btn.FlatAppearance.BorderSize = 0;
        btn.FlatAppearance.MouseOverBackColor = corLaranja;
        btn.FlatAppearance.MouseDownBackColor = corAzul;
        btn.Click += click;
        return btn;
    }

    private void OnMenuClick(object sender, EventArgs e)
    {
        var btn = sender as Button;
        string tema = btn.Tag.ToString();
        // Resetar cores
        foreach (Control c in panelMenuSuperior.Controls)
        {
            if (c is Button b)
            {
                b.BackColor = corBranco;
                b.ForeColor = corAzul;
            }
        }
        // Selecionado
        btn.BackColor = corAzul;
        btn.ForeColor = corBranco;
        ShowLateralMenu(tema);
    }

    private void ShowLateralMenu(string tema)
    {
        panelLateral.Controls.Clear();
        panelCentral.Controls.Clear();
        if (tema == "inicio")
        {
            ShowCentralContent(userControlHome);
        }
        else if (tema == "softwares")
        {
            // Painel lateral: botões dos instaladores
            int top = 30;
            foreach (var sw in softwares)
            {
                var btn = new Button
                {
                    Text = "  " + sw.Nome,
                    Width = 200,
                    Height = 50,
                    Top = top,
                    Left = 10,
                    Font = new Font("Segoe UI", 10F),
                    Image = ResourceImages.GetImage(sw.Icone),
                    ImageAlign = ContentAlignment.MiddleLeft,
                    TextAlign = ContentAlignment.MiddleRight,
                    FlatStyle = FlatStyle.Flat,
                    BackColor = corBranco,
                    ForeColor = corAzul,
                    Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right,
                    Tag = sw.Nome
                };
                btn.FlatAppearance.BorderSize = 0;
                btn.FlatAppearance.MouseOverBackColor = corLaranja;
                btn.FlatAppearance.MouseDownBackColor = corAzul;
                btn.Click += (s, e) => ShowCentralContent(new UserControlSoftwareFunction(sw.Nome, sw.Icone));
                panelLateral.Controls.Add(btn);
                top += 60;
            }
            // Mostra instrução no painel central
            ShowCentralContent(new UserControlSoftwareFunction(null, null));
        }
        else if (tema == "tools")
        {
            var btn = new Button
            {
                Text = "  Otimização do Windows",
                Width = 200,
                Height = 50,
                Top = 30,
                Left = 10,
                Font = new Font("Segoe UI", 10F),
                Image = ResourceImages.GetImage("tools.png"),
                ImageAlign = ContentAlignment.MiddleLeft,
                TextAlign = ContentAlignment.MiddleRight,
                FlatStyle = FlatStyle.Flat,
                BackColor = corBranco,
                ForeColor = corAzul,
                Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right
            };
            btn.FlatAppearance.BorderSize = 0;
            btn.FlatAppearance.MouseOverBackColor = corLaranja;
            btn.FlatAppearance.MouseDownBackColor = corAzul;
            btn.Click += (s, e) => ShowCentralContent(userControlTools);
            panelLateral.Controls.Add(btn);
            ShowCentralContent(null);
        }
        else if (tema == "fiscal")
        {
            var btn = new Button
            {
                Text = "  Editor de XML da NFe",
                Width = 200,
                Height = 50,
                Top = 30,
                Left = 10,
                Font = new Font("Segoe UI", 10F),
                Image = ResourceImages.GetImage("xml.png"),
                ImageAlign = ContentAlignment.MiddleLeft,
                TextAlign = ContentAlignment.MiddleRight,
                FlatStyle = FlatStyle.Flat,
                BackColor = corBranco,
                ForeColor = corAzul,
                Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right
            };
            btn.FlatAppearance.BorderSize = 0;
            btn.FlatAppearance.MouseOverBackColor = corLaranja;
            btn.FlatAppearance.MouseDownBackColor = corAzul;
            btn.Click += (s, e) => ShowCentralContent(userControlFiscalXmlEditor);
            panelLateral.Controls.Add(btn);
            ShowCentralContent(null);
        }
    }

    private void ShowCentralContent(UserControl control)
    {
        panelCentral.Controls.Clear();
        if (control != null)
        {
            control.Dock = DockStyle.Fill;
            panelCentral.Controls.Add(control);
        }
    }
}
